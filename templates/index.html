<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Portfolio Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f7f9fb;
            margin: 0;
            padding: 2rem;
        }
        #chart {
            max-width: 900px;
            margin: auto;
        }
        .buttons {
            text-align: center;
            margin-top: 1rem;
        }
        .buttons button {
            margin: 0 5px;
            padding: 0.5rem 1rem;
            font-weight: bold;
            border: 1px solid #ccc;
            border-radius: 5px;
            background: white;
            cursor: pointer;
        }
        .buttons button:hover {
            background: #eee;
        }
    </style>
</head>
<body>

<h2 style="text-align:center;">Equity Over Time</h2>

<div id="chart"></div>
<div class="buttons">
    <button onclick="changeRange('1D')">1D</button>
    <button onclick="changeRange('5D')">5D</button>
    <button onclick="changeRange('1M')">1M</button>
    <button onclick="changeRange('3M')">3M</button>
    <button onclick="changeRange('6M')">6M</button>
    <button onclick="changeRange('1Y')">1Y</button>
    <button onclick="changeRange('ALL')">ALL</button>
</div>
<script>
let fullData = [];

fetch('/api/equity')
    .then(res => res.json())
    .then(data => {
        fullData = data.map(d => ({
            x: new Date(d.time * 1000),
            y: d.equity
        }));
        drawChart(fullData);
    });

let chart;

function drawChart(seriesData) {
    const options = {
        chart: {
            type: 'area',
            height: 400,
            zoom: { enabled: true },
            toolbar: { show: false },
            stacked: false,

        },
        toolbar: {
            autoSelected: 'zoom'
          },
          dataLabels: {
          enabled: false
        },
        series: [{
            name: 'Equity Value',
            data: seriesData
        }],
        xaxis: {
            type: 'datetime',
            labels: {
                datetimeFormatter: {
                    year: 'yyyy',
                    month: "MMM 'yy",
                    day: 'dd MMM',
                    hour: "HH:mm",
                    minute: "HH:mm",
                }
            }
        },
        yaxis: {
            labels: {
                formatter: val => `$${val.toFixed(0)}`
            }
        },
        tooltip: {
            x: { format: 'MMM dd, yyyy HH:mm' },
            y: {
                formatter: val => `$${val.toFixed(2)}`
            }
        },
        stroke: {
            curve: 'smooth',
            width: 2
        },
        colors: ['#0f9d58'],
        fill: {
            type: 'gradient',
            gradient: {
                shadeIntensity: 1,
                opacityFrom: 0.4,
                opacityTo: 0.05,
                stops: [0, 90, 100]
            }
        }
    };

    chart = new ApexCharts(document.querySelector("#chart"), options);
    chart.render();
}
function changeRange(range) {
    const now = new Date();
    let from;

    if (range === '1D' || range === '5D') {
        url = range === '1D' ? '/api/equity/intraday?days=1&interval=1m' : '/api/equity/intraday?days=7&interval=30m'
        fetch(url)
            .then(res => res.json())
            .then(data => {
                const cutoff = range === '1D'
                    ? Date.now() - 24 * 60 * 60 * 1000
                    : Date.now() - 5 * 24 * 60 * 60 * 1000;

                const filtered = data
                    .map(d => ({ x: new Date(d.time * 1000), y: d.equity }))
                    .filter(d => d.x.getTime() >= cutoff);

                chart.updateSeries([{ data: filtered }]);
            });
        return;
    }


    switch (range) {
        case '1M': from = new Date(); from.setMonth(from.getMonth() - 1); break;
        case '3M': from = new Date(); from.setMonth(from.getMonth() - 3); break;
        case '6M': from = new Date(); from.setMonth(from.getMonth() - 6); break;
        case '1Y': from = new Date(); from.setFullYear(from.getFullYear() - 1); break;
        case 'ALL': chart.updateSeries([{ data: fullData }]); return;
    }

    const filtered = fullData.filter(d => d.x >= from);
    chart.updateSeries([{ data: filtered }]);
}
</script>

</body>
</html>
